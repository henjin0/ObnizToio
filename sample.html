<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" />
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://unpkg.com/obniz@3.5.0/obniz.js" crossorigin="anonymous"></script>
</head>

<body>

<button id="up">up</button>
<button id="down">down</button>
<button id="R">R</button>
<button id="L">L</button>
<br/>
<button id="move">move</button>
<br/>
<button id="hello">Hello, Toio(Connect)</button>
<br/>
<button id="bye">Bye Bye(Disconnect)</button>
<br/>
<div id="status">Wait...</div>
<br/>
Pos X:<span id="posx">NaN</span> Pos Y:<span id="posy">NaN</span>

<script>
    class Toio {

        constructor(peripheral) {
            this.serviceID = "10B20100-5B3B-4571-9508-CF3EFCD7BBAE";
            this.characteristicIDMotor = "10B20102-5B3B-4571-9508-CF3EFCD7BBAE";
            this.characteristicIDPos = "10B20101-5B3B-4571-9508-CF3EFCD7BBAE";
            this.peripheral = peripheral;

            this.peripheralUUID = peripheral.uuid;
        }

        wired(obniz){}

        isDevice(peripheral){
            if (peripheral.localName == "toio Core Cube"){
                return true;
            }else{
                return false;
            }
        }

        async connectWait(timeout=100){
            this.timeout = timeout;

            if(this.peripheral) {
                console.log("found");

                if (this.isDevice(this.peripheral)) {
                    console.log("It's toio!");
                } else {
                    console.log("It's not toio!");
                    return 1;
                }

                this.peripheral.onerror = function(err){
                    console.log("error : " + err.message);
                }

                let i = 0;
                for(i=0; i<5; i++)
                {
                    try {
                        await this.peripheral.connectWait();
                        console.log("connected");
                        return 0;

                    } catch (e) {
                        console.error(e);

                        const sleep = function(ms) {
                            return new Promise(resolve => setTimeout(resolve, ms));
                        };
                        const wait = async function(ms){
                            await sleep(ms);
                        }

                        await wait(this.timeout);
                    }
                }
            }

            return -1
        }

        async disconnectWait(){
            await this.peripheral.disconnect();
        }

        async getPosition(){
            let readData = await this.peripheral.getService(this.serviceID).getCharacteristic(this.characteristicIDPos).readWait();
            let obj = new Object();

            //NOTE: toioの中心から見たポジション
            obj.posX = readData[2]<<8|readData[1];
            obj.posY = readData[4]<<8|readData[3];
            obj.angle = readData[6]<<8|readData[5];
            obj.posSensorX = readData[8]<<8|readData[7];
            obj.posSensorY = readData[10]<<8|readData[9];
            obj.posSensorAngle = readData[12]<<8|readData[11];

            return obj;
        }


        async moveAround(leftWheelPower=0, rightWheelPower=0){
            let constraintWheelPower = function(wheelPower){
                // NOTE: Power is limited belong 0 to 255. And minus value is backward.
                if (wheelPower < -255){
                    wheelPower = -255;
                }else if(wheelPower > 255){
                    wheelPower = 255;

                }
                return wheelPower;
            }

            let numWheelDirection = function(wheelPower){
                // NOTE: 1 is forward. and 2 is backward.
                if(wheelPower >= 0){
                    return 1;
                }else if(wheelPower < 0){
                    return 2;
                }
            }

            leftWheelPower = constraintWheelPower(leftWheelPower);
            rightWheelPower = constraintWheelPower(rightWheelPower);
            var leftWheelDirection = numWheelDirection(leftWheelPower);
            var rightWheelDirection = numWheelDirection(rightWheelPower);

            await this.peripheral.getService(this.serviceID).getCharacteristic(this.characteristicIDMotor).
            writeWait([1,
                1,leftWheelDirection,Math.abs(leftWheelPower),
                2,rightWheelDirection,Math.abs(rightWheelPower)]);
        }


        async movePosition(timeoutSec=5,
                           moveType=0, maxWheelPower=30, wheelPowerType=30,
                           targetPosX=0, targetPosY=0, targetAngle=0){

            let parceNumber = function(pos){
                //NOTE: Pos is must hove belong 0 to 65535.
                if(pos > 65535){
                    pos = 65535;
                }else if(pos < 0){
                    pos = 0;
                }

                let buffer = new ArrayBuffer(2);
                let dv = new DataView(buffer);
                dv.setUint16(0,pos);

                let obj = new Object();
                obj.value1 = dv.getUint8(0);
                obj.value2 = dv.getUint8(1);
                console.log(obj.value1.toString(16)+obj.value2.toString(16));
                return obj;
            }

            let posXObj = parceNumber(targetPosX);
            let posYObj = parceNumber(targetPosY);
            let targetAngleObj = parceNumber(targetAngle);

            await this.peripheral.getService(this.serviceID).getCharacteristic(this.characteristicIDMotor).
            writeWait([0x03,0x00,
                timeoutSec,moveType,maxWheelPower,
                wheelPowerType,0x00,
                posXObj.value2, posXObj.value1,
                posYObj.value2, posYObj.value1,
                targetAngleObj.value2, targetAngleObj.value1]);
        }
    }


    var obniz = new Obniz("XXXX-XXXX");
    obniz.onconnect = async function () {
        await obniz.ble.initWait();


        var target = {
            localName: "toio Core Cube"
        };

        var peripheral = await obniz.ble.scan.startOneWait(target);

        if(peripheral) {
            let toio = new Toio(peripheral);

            if(await toio.connectWait()!=0){
                document.getElementById("status").innerText = "Toio is disconnected.";
                return;
            }
            console.log("found");
            document.getElementById("status").innerText = "Toio is ready!";

            try {

                // UP
                await $("#up").on("touchstart mousedown",async function(){
                    console.log("push");
                    obniz.display.clear();
                    obniz.display.print("UP!");

                    await toio.moveAround(255,255);
                    let readDataObj = await toio.getPosition();
                    document.getElementById("posx").innerText = String(readDataObj.posX);
                    document.getElementById("posy").innerText = String(readDataObj.posY);

                });
                await $("#up").on("touchstart mouseup",async function(){
                    console.log("release");
                    obniz.display.clear();
                    obniz.display.print("STOP!");

                    await toio.moveAround(0,0);
                    let readDataObj = await toio.getPosition();
                    document.getElementById("posx").innerText = String(readDataObj.posX);
                    document.getElementById("posy").innerText = String(readDataObj.posY);
                });

                // DOWN
                await $("#down").on("touchstart mousedown",async function(){
                    console.log("push");
                    obniz.display.clear();
                    obniz.display.print("DOWN!");

                    await toio.moveAround(-255,-255);
                    let readDataObj = await toio.getPosition();
                    document.getElementById("posx").innerText = String(readDataObj.posX);
                    document.getElementById("posy").innerText = String(readDataObj.posY);
                });
                await $("#down").on("touchstart mouseup",async function(){
                    console.log("release");
                    obniz.display.clear();
                    obniz.display.print("STOP!");

                    await toio.moveAround(0,0);
                    let readDataObj = await toio.getPosition();
                    document.getElementById("posx").innerText = String(readDataObj.posX);
                    document.getElementById("posy").innerText = String(readDataObj.posY);
                });

                // Left
                await $("#L").on("touchstart mousedown",async function(){
                    console.log("push");
                    obniz.display.clear();
                    obniz.display.print("LEFT TURN!");

                    await toio.moveAround(255,-255);
                    let readDataObj = await toio.getPosition();
                    document.getElementById("posx").innerText = String(readDataObj.posX);
                    document.getElementById("posy").innerText = String(readDataObj.posY);
                });
                await $("#L").on("touchstart mouseup",async function(){
                    console.log("release");
                    obniz.display.clear();
                    obniz.display.print("STOP TURN!");

                    await toio.moveAround(0,0);
                    let readDataObj = await toio.getPosition();
                    document.getElementById("posx").innerText = String(readDataObj.posX);
                    document.getElementById("posy").innerText = String(readDataObj.posY);
                });

                // Right
                await $("#R").on("touchstart mousedown",async function(){
                    console.log("push");
                    obniz.display.clear();
                    obniz.display.print("RIGHT TURN!");

                    await toio.moveAround(-255,255);
                    let readDataObj = await toio.getPosition();
                    document.getElementById("posx").innerText = String(readDataObj.posX);
                    document.getElementById("posy").innerText = String(readDataObj.posY);
                });
                await $("#R").on("touchstart mouseup",async function(){
                    console.log("release");
                    obniz.display.clear();
                    obniz.display.print("STOP TURN!");

                    await toio.moveAround(0,0);
                    let readDataObj = await toio.getPosition();
                    document.getElementById("posx").innerText = String(readDataObj.posX);
                    document.getElementById("posy").innerText = String(readDataObj.posY);
                });


                await $("#move").on("touchstart mousedown",async function(){
                    console.log("push");
                    obniz.display.clear();
                    obniz.display.print("MOVE");
                    // uint16は下位1バイトから先に入れる。
                    await toio.movePosition(5,
                        2, 100, 0,
                        300, 300, 0);
                    let readDataObj = await toio.getPosition();
                    document.getElementById("posx").innerText = String(readDataObj.posX);
                    document.getElementById("posy").innerText = String(readDataObj.posY);
                });

                await $("#bye").on("touchstart mousedown",async function(){
                    console.log("bye");
                    obniz.display.clear();
                    obniz.display.print("Bye Bye");
                    await toio.disconnectWait();
                    document.getElementById("status").innerText = "Toio is disconnected.";
                });

                await $("#hello").on("touchstart mousedown",async function(){
                    peripheral = await obniz.ble.scan.startOneWait(target);
                    if(await toio.connectWait()!=0){
                        document.getElementById("status").innerText = "Toio is connected.";
                        console.log("failed reconnect");
                        obniz.display.clear();
                        obniz.display.print("failure reconnect!");
                    }else {
                        document.getElementById("status").innerText = "Toio is connected.";
                        console.log("reconnect");
                        obniz.display.clear();
                        obniz.display.print("reconnect!");
                    }
                });

            } catch(e) {
                console.error(e);
                document.getElementById("status").innerText = "Toio is disconnected.";
            }
        }


    }
</script>
</body>

</html>